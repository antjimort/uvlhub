{% extends "generator/index.html" %}

{% block title %}Generate random feature models{% endblock %}

{% block wizard_content %}
<div class="row justify-content-center">
    <div class="col-md-8">

        <h3 class="mb-3">Attributes</h3>

        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="random_attributes" name="random_attributes" checked>
            <label class="form-check-label" for="random_attributes">Random attributes</label>
        </div>

        <div id="random-attributes-settings">
            <div class="mb-3 d-flex align-items-center gap-3">
                <label for="min_attributes" class="form-label mb-0">Min:</label>
                <input type="number" class="form-control" style="width:90px;" min="1" max="100" id="min_attributes" name="min_attributes" value="1">
                <label for="max_attributes" class="form-label mb-0 ms-3">Max:</label>
                <input type="number" class="form-control" style="width:90px;" min="1" max="100" id="max_attributes" name="max_attributes" value="5">
            </div>
        </div>

        <!-- Manual attributes (hidden by default) -->
        <div id="manual-attributes-section" style="display: none;">
            <div class="mb-3">
                <button type="button" class="btn btn-outline-primary" id="add-attribute-btn">Add</button>
                <button type="button" class="btn btn-outline-danger" id="delete-attribute-btn">Delete last one</button>
            </div>
            <div id="manual-attributes-list">
                <!-- Attribute cards get inserted here -->
            </div>
        </div>
    </div>
</div>

<script>
const randomCheckbox = document.getElementById('random_attributes');
const randomSettings = document.getElementById('random-attributes-settings');
const manualSection = document.getElementById('manual-attributes-section');
const manualAttributesList = document.getElementById('manual-attributes-list');

randomCheckbox.addEventListener('change', function() {
    if (this.checked) {
        randomSettings.style.display = 'block';
        manualSection.style.display = 'none';
    } else {
        randomSettings.style.display = 'none';
        manualSection.style.display = 'block';
        // Ensure at least one attribute card by default
        if (manualAttributesList.getElementsByClassName('manual-attribute-card').length === 0) {
            addAttributeCard();
        }
    }
});

document.getElementById('add-attribute-btn').addEventListener('click', addAttributeCard);
document.getElementById('delete-attribute-btn').addEventListener('click', function() {
    const cards = manualAttributesList.getElementsByClassName('manual-attribute-card');
    if (cards.length > 0) {
        cards[cards.length-1].remove();
    }
});

// -- Nuevo: Manejar el Value seg√∫n tipo --
function updateValueField(card, type) {
    const valueDiv = card.querySelector('.value-field');
    if (type === 'boolean') {
        valueDiv.innerHTML = `
            <label class="form-label">Value</label>
            <select class="form-select" name="attr_value">
                <option value="True">True</option>
                <option value="False">False</option>
            </select>
        `;
    } else {
        valueDiv.innerHTML = `
            <label class="form-label">Value</label>
            <input type="text" class="form-control" name="attr_value" placeholder="(e.g. 5 or Red)">
        `;
    }
}

// Template for a new attribute card
function addAttributeCard() {
    const idx = manualAttributesList.children.length;
    const card = document.createElement('div');
    card.className = 'card p-3 mb-3 manual-attribute-card';

    card.innerHTML = `
        <div class="mb-2">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" name="attr_name" placeholder="e.g. Seats" required>
        </div>
        <div class="mb-2">
            <label class="form-label">Type</label>
            <select class="form-select attr-type-select" name="attr_type">
                <option value="integer">Integer</option>
                <option value="real">Real</option>
                <option value="boolean">Boolean</option>
                <option value="string">String</option>
            </select>
        </div>
        <div class="mb-2 value-field">
            <!-- Value input (dynamic) -->
        </div>
        <div class="mb-2">
            <label class="form-label">Attach probability</label>
            <input type="number" class="form-control" name="attr_attach_prob" step="0.01" min="0" max="1" value="0.7">
        </div>
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="attr_use_in_constraints" id="attr_use_in_constraints_${idx}" checked>
            <label class="form-check-label" for="attr_use_in_constraints_${idx}">Use in constraints</label>
        </div>
    `;
    manualAttributesList.appendChild(card);

    // Inicializa el value field (por defecto tipo integer)
    updateValueField(card, 'integer');
    // Listener para cambiar el value field si cambia el tipo
    card.querySelector('.attr-type-select').addEventListener('change', function() {
        updateValueField(card, this.value);
    });
}

// Si user entra con random desmarcado, mostrar al menos un bloque manual
if (!randomCheckbox.checked) addAttributeCard();
</script>
{% endblock %}
